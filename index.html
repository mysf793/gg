<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timer & Stopwatch Server-Side</title>
<style>
    :root {
        --bg: #121212;
        --card: #1e1e1e;
        --text: #ffffff;
        --timer-color: #3498db;
        --stopwatch-color: #9b59b6;
        --danger: #e74c3c;
        --success: #2ecc71;
    }

    body {
        font-family: 'Segoe UI', Roboto, sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
    }

    /* Buttons */
    button {
        padding: 10px 15px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        color: white;
        transition: 0.2s;
    }
    button:active { transform: scale(0.95); }
    .btn-timer { background: var(--timer-color); }
    .btn-sw { background: var(--stopwatch-color); }
    .btn-danger { background: var(--danger); }
    .btn-success { background: var(--success); }
    .btn-control { width: 40px; height: 40px; font-size: 1.2rem; padding: 0; margin: 0 5px; }

    #main-menu { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }

    /* Input Panels */
    .control-panel {
        display: none;
        background: #252525;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #444;
        gap: 10px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        justify-content: center;
    }
    input { padding: 10px; background: #333; border: 1px solid #555; color: white; border-radius: 5px; text-align: center; }
    .input-name { width: 150px; text-align: left; }
    .input-time { width: 50px; }

    /* Container */
    #container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        width: 100%;
        max-width: 1200px;
    }

    /* Cards */
    .card {
        background: var(--card);
        border: 1px solid #333;
        border-radius: 15px;
        padding: 20px;
        width: 280px;
        text-align: center;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .card.timer-mode { border-top: 4px solid var(--timer-color); }
    .card.sw-mode { border-top: 4px solid var(--stopwatch-color); }
    
    .card-title { color: #aaa; font-size: 0.9rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
    .time-display { font-size: 3rem; font-weight: 700; font-variant-numeric: tabular-nums; margin: 10px 0; }
    .money-display { color: #f1c40f; font-weight: bold; font-size: 1.2rem; margin-bottom: 15px; }
    
    .badge {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 0.7rem;
        padding: 3px 6px;
        border-radius: 4px;
        background: #333;
    }
    .running .badge { background: var(--success); color: #000; }
    
    #role-indicator { margin-top: auto; padding: 30px; color: #555; font-size: 0.8rem; }
</style>
</head>
<body>

    <h1 style="color:#888;">CLOUD TIMER & STOPWATCH</h1>

    <div id="main-menu">
        <button class="btn-timer" onclick="togglePanel('timer')">+ Timer Baru</button>
        <button class="btn-sw" onclick="togglePanel('stopwatch')">+ Stopwatch Baru</button>
        <button class="btn-danger" onclick="deleteAll()">Reset Sistem</button>
    </div>

    <div id="panel-timer" class="control-panel">
        <input id="timerName" class="input-name" placeholder="Nama Timer">
        <div style="display:flex; align-items:center; gap:5px;">
            <input id="timerHours" class="input-time" type="number" min="0" placeholder="Jam"> :
            <input id="timerMinutes" class="input-time" type="number" min="0" placeholder="Mnt">
        </div>
        <button class="btn-success" onclick="addTimer()">TAMBAH</button>
    </div>

    <div id="panel-stopwatch" class="control-panel">
        <input id="swName" class="input-name" placeholder="Nama Stopwatch">
        <button class="btn-success" onclick="addStopwatch()">TAMBAH</button>
    </div>

    <div id="container"></div>

    <div id="role-indicator">MODE: VIEWER</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, remove, onValue, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyCb9y-NzS2coR8UFlWE6Nb3r27baCS1mz4",
        authDomain: "timer-89517.firebaseapp.com",
        databaseURL: "https://timer-89517-default-rtdb.firebaseio.com",
        projectId: "timer-89517"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    // Kita gunakan path "v3" untuk sistem timestamp baru
    const timersRef = ref(db, "v3/timers");
    const stopwatchRef = ref(db, "v3/stopwatches");

    let timersData = {};
    let stopwatchData = {};
    let isAdmin = false;

    // --- LOGIC AUTH ADMIN ---
    const urlParams = new URLSearchParams(location.search);
    if (urlParams.get("role") === "admin") {
        const pwd = prompt("MASUKKAN PASSWORD ADMIN:");
        if (pwd === "redmimahal") {
            isAdmin = true;
            document.getElementById("role-indicator").innerText = "MODE: ADMIN (MASTER)";
            document.getElementById("role-indicator").style.color = "#e74c3c";
        } else {
            alert("Password Salah!");
        }
    }

    // --- LISTENER DATABASE ---
    onValue(timersRef, (snap) => {
        timersData = snap.val() || {};
        // Tidak perlu memanggil render di sini, render dipanggil oleh setInterval lokal
    });
    onValue(stopwatchRef, (snap) => {
        stopwatchData = snap.val() || {};
    });

    // --- ENGINE UTAMA (CLIENT SIDE TICKER) ---
    // Interval ini berjalan di SEMUA browser (Viewer & Admin) hanya untuk update tampilan
    // Database tidak di-update oleh interval ini, jadi aman jika tab ditutup.
    setInterval(() => {
        const container = document.getElementById("container");
        // Kita membangun HTML string baru setiap detik agar responsif
        let htmlContent = "";

        const now = Date.now();

        // 1. PROSES TIMER
        Object.keys(timersData).forEach(key => {
            const t = timersData[key];
            let remainingMS = 0;

            if (t.isRunning) {
                // Rumus: Waktu Selesai - Waktu Sekarang
                remainingMS = t.endTime - now;
                if (remainingMS < 0) remainingMS = 0;
            } else {
                // Jika pause, gunakan waktu sisa yang disimpan
                remainingMS = t.pausedLeft;
            }

            // Format Tampilan
            const totalSeconds = Math.ceil(remainingMS / 1000);
            const h = String(Math.floor(totalSeconds / 3600)).padStart(2,"0");
            const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2,"0");
            const s = String(totalSeconds % 60).padStart(2,"0");

            const controls = isAdmin ? `
                <div class="card-controls">
                    <button class="btn-control ${t.isRunning?'btn-danger':'btn-success'}" 
                        onclick="window.toggleTimer('${key}', ${!t.isRunning})">
                        ${t.isRunning ? '‚è∏' : '‚ñ∂'}
                    </button>
                    <button class="btn-control btn-timer" onclick="window.resetTimer('${key}')">‚Ü∫</button>
                    <button class="btn-control btn-danger" onclick="window.deleteItem('timers', '${key}')">‚úñ</button>
                </div>
            ` : '';

            htmlContent += `
                <div class="card timer-mode ${t.isRunning && remainingMS > 0 ?'running':''}">
                    <div class="badge">${t.isRunning && remainingMS > 0 ?'JALAN':'PAUSE'}</div>
                    <div class="card-title">${t.name}</div>
                    <div class="time-display">${h}:${m}:${s}</div>
                    ${controls}
                </div>
            `;
        });

        // 2. PROSES STOPWATCH
        Object.keys(stopwatchData).forEach(key => {
            const sw = stopwatchData[key];
            let elapsedMS = 0;

            if (sw.isRunning) {
                // Rumus: (Waktu Sekarang - Waktu Mulai) + Akumulasi Waktu Sebelumnya
                elapsedMS = (now - sw.startTime) + (sw.accumulated || 0);
            } else {
                elapsedMS = sw.accumulated || 0;
            }

            const totalSeconds = Math.floor(elapsedMS / 1000);
            const h = String(Math.floor(totalSeconds / 3600)).padStart(2,"0");
            const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2,"0");
            const s = String(totalSeconds % 60).padStart(2,"0");
            
            // Hitung Uang: 100 rupiah per menit
            const money = Math.floor(totalSeconds / 60) * 100;

            const controls = isAdmin ? `
                <div class="card-controls">
                    <button class="btn-control ${sw.isRunning?'btn-danger':'btn-success'}" 
                        onclick="window.toggleStopwatch('${key}', ${!sw.isRunning})">
                        ${sw.isRunning ? '‚è∏' : '‚ñ∂'}
                    </button>
                    <button class="btn-control btn-danger" onclick="window.resetStopwatch('${key}')">‚Ü∫</button>
                    <button class="btn-control btn-danger" onclick="window.deleteItem('stopwatches', '${key}')">‚úñ</button>
                </div>
            ` : '';

            htmlContent += `
                <div class="card sw-mode ${sw.isRunning?'running':''}">
                    <div class="badge">${sw.isRunning?'JALAN':'PAUSE'}</div>
                    <div class="card-title">${sw.name}</div>
                    <div class="time-display">${h}:${m}:${s}</div>
                    <div class="money-display">üí∞ Rp ${money.toLocaleString('id-ID')}</div>
                    ${controls}
                </div>
            `;
        });

        container.innerHTML = htmlContent;

    }, 200); // Update tampilan tiap 200ms agar smooth

    // --- UI FUNCTIONS ---
    window.togglePanel = (type) => {
        if(!isAdmin) return alert("Hanya admin!");
        document.querySelectorAll('.control-panel').forEach(el => el.style.display = 'none');
        document.getElementById(`panel-${type}`).style.display = 'flex';
    };

    // --- LOGIC DATABASE (HANYA MENGUBAH STATE) ---

    // 1. TAMBAH DATA
    window.addTimer = () => {
        const name = document.getElementById("timerName").value || "Timer";
        const h = parseInt(document.getElementById("timerHours").value) || 0;
        const m = parseInt(document.getElementById("timerMinutes").value) || 0;
        const durationMS = ((h * 3600) + (m * 60)) * 1000;

        if (durationMS <= 0) return alert("Waktu minimal 1 menit");

        push(timersRef, {
            name: name,
            originalDuration: durationMS, // Durasi asli untuk reset
            pausedLeft: durationMS,       // Sisa waktu saat ini (awal = full)
            endTime: 0,                   // Belum jalan
            isRunning: false
        });
        
        document.getElementById("timerName").value = "";
    };

    window.addStopwatch = () => {
        const name = document.getElementById("swName").value || "Stopwatch";
        push(stopwatchRef, {
            name: name,
            startTime: 0,
            accumulated: 0, // Menyimpan waktu yang sudah berlalu sebelum pause
            isRunning: false
        });
        document.getElementById("swName").value = "";
    };

    // 2. KONTROL TIMER
    window.toggleTimer = (key, wantStart) => {
        const t = timersData[key];
        const now = Date.now();

        if (wantStart) {
            // START: Set endTime = Sekarang + Sisa Waktu yang disimpan
            update(ref(db, `v3/timers/${key}`), {
                isRunning: true,
                endTime: now + t.pausedLeft
            });
        } else {
            // PAUSE: Hitung sisa waktu sekarang, simpan ke pausedLeft
            const currentRemaining = t.endTime - now;
            update(ref(db, `v3/timers/${key}`), {
                isRunning: false,
                pausedLeft: currentRemaining > 0 ? currentRemaining : 0
            });
        }
    };

    window.resetTimer = (key) => {
        const t = timersData[key];
        update(ref(db, `v3/timers/${key}`), {
            isRunning: false,
            pausedLeft: t.originalDuration,
            endTime: 0
        });
    };

    // 3. KONTROL STOPWATCH
    window.toggleStopwatch = (key, wantStart) => {
        const sw = stopwatchData[key];
        const now = Date.now();

        if (wantStart) {
            // START: Set startTime baru
            update(ref(db, `v3/stopwatches/${key}`), {
                isRunning: true,
                startTime: now
            });
        } else {
            // PAUSE: Tambahkan durasi sesi ini ke accumulated
            const sessionDuration = now - sw.startTime;
            update(ref(db, `v3/stopwatches/${key}`), {
                isRunning: false,
                accumulated: (sw.accumulated || 0) + sessionDuration
            });
        }
    };

    window.resetStopwatch = (key) => {
        update(ref(db, `v3/stopwatches/${key}`), {
            isRunning: false,
            accumulated: 0,
            startTime: 0
        });
    };

    // 4. HAPUS
    window.deleteItem = (type, key) => {
        if(confirm("Hapus item ini?")) remove(ref(db, `v3/${type}/${key}`));
    };

    window.deleteAll = async () => {
        if(!isAdmin) return alert("Akses Ditolak");
        if(confirm("RESET SEMUA KE NOL?")) {
            await set(ref(db, 'v3'), null);
        }
    };

</script>
</body>
</html>
