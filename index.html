<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi Timer + Stopwatch Uang</title>
<style>
    :root {
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --text-main: #ffffff;
        --text-sec: #b0b0b0;
        --accent: #3498db;
        --danger: #e74c3c;
        --success: #2ecc71;
    }

    body {
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
    }

    h1 { margin-bottom: 20px; font-size: 1.5rem; color: var(--text-sec); }

    /* Buttons */
    button {
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.1s, opacity 0.2s;
        color: white;
    }
    button:active { transform: scale(0.95); }
    button:hover { opacity: 0.9; }

    .btn-primary { background: var(--accent); }
    .btn-success { background: var(--success); }
    .btn-danger { background: var(--danger); }
    .btn-warning { background: #f1c40f; color: #333; }
    
    #main-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        justify-content: center;
    }

    /* Controls Panel */
    #control-panel {
        display: none; /* Hidden by default */
        gap: 10px;
        background: #2c2c2c;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 25px;
        border: 1px solid #444;
        align-items: center;
    }
    input {
        padding: 10px;
        background: #3a3a3a;
        border: 1px solid #555;
        color: white;
        border-radius: 6px;
    }
    input[type="number"] { width: 60px; }

    /* Grid Container */
    #timers-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        width: 100%;
        max-width: 1200px;
        margin-bottom: 30px;
    }

    /* Cards */
    .card {
        background: var(--card-bg);
        border: 1px solid #333;
        border-radius: 16px;
        padding: 20px;
        width: 280px;
        text-align: center;
        position: relative;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .card.running { border-color: var(--success); }
    .card.paused { border-color: #555; }

    .timer-display {
        font-size: 3.5rem;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        margin: 10px 0;
    }

    .money-display {
        font-size: 1.2rem;
        color: #f1c40f;
        font-weight: bold;
        margin-bottom: 15px;
    }

    .card-controls {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-top: 15px;
    }

    .badge {
        position: absolute;
        top: 12px;
        right: 12px;
        font-size: 0.75rem;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
    }
    .bg-green { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
    .bg-red { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }

    .role-indicator {
        margin-top: auto;
        padding: 20px;
        font-size: 0.9rem;
        color: #666;
        letter-spacing: 1px;
        text-transform: uppercase;
    }
</style>
</head>
<body>

    <h1>DASHBOARD WAKTU</h1>

    <div id="main-buttons">
        <button class="btn-primary" onclick="window.showTimerPanel()">+ Timer Baru</button>
        <button class="btn-danger" onclick="window.deleteAll()">Reset Semua</button>
    </div>

    <div id="control-panel">
        <input id="newName" placeholder="Nama Kegiatan (ex: Lari)">
        <input id="newMinutes" type="number" min="1" value="10" placeholder="Menit">
        <button class="btn-success" onclick="window.createNewTimer()">Buat Timer</button>
    </div>

    <div id="timers-container">
        </div>

    <div class="card" id="sw-card">
        <div class="badge" id="sw-status-badge">PAUSED</div>
        <div style="color:#aaa; font-size:0.9rem; margin-top:5px;">STOPWATCH UANG</div>
        <div class="timer-display" id="sw-time">00:00</div>
        <div class="money-display">üí∞ Rp <span id="sw-money">0</span></div>

        <div class="card-controls" id="sw-controls" style="display:none">
            <button class="btn-success" onclick="window.toggleStopwatch(true)">START</button>
            <button class="btn-warning" onclick="window.toggleStopwatch(false)">PAUSE</button>
            <button class="btn-danger" onclick="window.resetStopwatch()">RESET</button>
        </div>
    </div>

    <div class="role-indicator" id="role-status">MODE: VIEWER</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, remove, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- KONFIGURASI FIREBASE ---
    // Pastikan Rules Firebase Database di set read/write: true untuk testing
    const firebaseConfig = {
        apiKey: "AIzaSyCb9y-NzS2coR8UFlWE6Nb3r27baCS1mz4",
        authDomain: "timer-89517.firebaseapp.com",
        databaseURL: "https://timer-89517-default-rtdb.firebaseio.com",
        projectId: "timer-89517"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const timersRef = ref(db, "multiTimers");
    const stopwatchRef = ref(db, "stopwatch");

    // --- STATE LOCAL ---
    let timers = {};
    let stopwatch = { seconds: 0, money: 0, isRunning: false };
    let isAdmin = false;

    // --- CEK MODE ADMIN ---
    // Cara pakai: tambahkan ?role=admin di akhir URL
    const urlParams = new URLSearchParams(location.search);
    if (urlParams.get("role") === "admin") {
        const pwd = prompt("MASUKKAN PASSWORD ADMIN:");
        if (pwd === "redmimahal") { // Ganti password sesuai keinginan
            isAdmin = true;
            document.getElementById("role-status").innerText = "MODE: ADMIN (MASTER)";
            document.getElementById("role-status").style.color = "#e74c3c";
            document.getElementById("role-status").style.fontWeight = "bold";
            
            // Tampilkan kontrol khusus admin
            document.getElementById("sw-controls").style.display = "flex";
        } else {
            alert("PASSWORD SALAH. AKSES DITOLAK.");
            window.location.search = ""; // Reload tanpa query
        }
    }

    // --- LISTENER FIREBASE (REALTIME UPDATE) ---
    
    // 1. Dengar perubahan data Timer
    onValue(timersRef, (snapshot) => {
        timers = snapshot.val() || {};
        renderTimers();
    });

    // 2. Dengar perubahan data Stopwatch
    onValue(stopwatchRef, (snapshot) => {
        stopwatch = snapshot.val() || { seconds: 0, money: 0, isRunning: false };
        renderStopwatch();
    });

    // --- FUNGSI RENDER (TAMPILAN) ---
    function renderTimers() {
        const container = document.getElementById("timers-container");
        container.innerHTML = "";

        Object.keys(timers).forEach(key => {
            const t = timers[key];
            const minutes = String(Math.floor(t.timeLeft / 60)).padStart(2, "0");
            const seconds = String(t.timeLeft % 60).padStart(2, "0");
            
            // Tentukan style berdasarkan status
            const statusClass = t.isRunning ? "running" : "paused";
            const badgeClass = t.isRunning ? "bg-green" : "bg-red";
            
            // Kontrol tombol (hanya jika Admin)
            let controlsHTML = "";
            if (isAdmin) {
                controlsHTML = `
                <div class="card-controls">
                    <button class="${t.isRunning ? 'btn-warning' : 'btn-success'}" 
                        onclick="window.toggleTimer('${key}', ${!t.isRunning})">
                        ${t.isRunning ? 'PAUSE' : 'START'}
                    </button>
                    <button class="btn-primary" onclick="window.resetTimer('${key}', ${t.initialTime})">R</button>
                    <button class="btn-danger" onclick="window.deleteTimer('${key}')">X</button>
                </div>`;
            }

            container.innerHTML += `
            <div class="card ${statusClass}">
                <div class="badge ${badgeClass}">${t.isRunning ? "RUNNING" : "PAUSED"}</div>
                <div style="color:#aaa; font-weight:600;">${t.name.toUpperCase()}</div>
                <div class="timer-display">${minutes}:${seconds}</div>
                ${controlsHTML}
            </div>`;
        });
    }

    function renderStopwatch() {
        const m = String(Math.floor(stopwatch.seconds / 60)).padStart(2, "0");
        const s = String(stopwatch.seconds % 60).padStart(2, "0");
        
        document.getElementById("sw-time").innerText = `${m}:${s}`;
        document.getElementById("sw-money").innerText = stopwatch.money.toLocaleString('id-ID');
        
        const badge = document.getElementById("sw-status-badge");
        const card = document.getElementById("sw-card");
        
        if(stopwatch.isRunning) {
            badge.innerText = "RUNNING";
            badge.className = "badge bg-green";
            card.classList.add("running");
        } else {
            badge.innerText = "PAUSED";
            badge.className = "badge bg-red";
            card.classList.remove("running");
        }
    }

    // --- LOGIC INTERVAL (KHUSUS ADMIN) ---
    // Hanya admin yang mengirim update waktu ke database
    if (isAdmin) {
        setInterval(() => {
            const updates = {};
            let hasUpdates = false;

            // 1. Update Semua Timer
            Object.keys(timers).forEach(key => {
                const t = timers[key];
                if (t.isRunning && t.timeLeft > 0) {
                    updates[`multiTimers/${key}/timeLeft`] = t.timeLeft - 1;
                    // Jika waktu habis, matikan timer
                    if (t.timeLeft - 1 <= 0) {
                        updates[`multiTimers/${key}/isRunning`] = false;
                        updates[`multiTimers/${key}/timeLeft`] = 0;
                    }
                    hasUpdates = true;
                }
            });

            // 2. Update Stopwatch Uang
            if (stopwatch.isRunning) {
                const nextSec = stopwatch.seconds + 1;
                updates["stopwatch/seconds"] = nextSec;
                
                // Tambah uang setiap 60 detik (Rp 100)
                if (nextSec % 60 === 0) {
                    updates["stopwatch/money"] = stopwatch.money + 100;
                }
                hasUpdates = true;
            }

            // Kirim semua update sekaligus agar efisien
            if (hasUpdates) {
                update(ref(db), updates).catch(err => console.error(err));
            }
        }, 1000); // Update setiap 1 detik
    }

    // --- EXPOSE FUNGSI KE WINDOW (Agar bisa dipanggil onclick HTML) ---
    
    // UI Helpers
    window.showTimerPanel = () => {
        if (!isAdmin) return alert("Hanya Admin yang bisa menambah timer!");
        const panel = document.getElementById("control-panel");
        panel.style.display = panel.style.display === "flex" ? "none" : "flex";
    };

    // Timer Actions
    window.createNewTimer = () => {
        if (!isAdmin) return;
        const name = document.getElementById("newName").value || "Kegiatan";
        const min = parseInt(document.getElementById("newMinutes").value) || 0;
        
        if (min <= 0) return alert("Waktu minimal 1 menit!");
        
        push(timersRef, {
            name: name,
            timeLeft: min * 60,
            initialTime: min * 60,
            isRunning: false
        });
        
        // Reset input
        document.getElementById("newName").value = "";
    };

    window.toggleTimer = (key, status) => {
        update(ref(db, `multiTimers/${key}`), { isRunning: status });
    };

    window.resetTimer = (key, initial) => {
        update(ref(db, `multiTimers/${key}`), { 
            timeLeft: initial, 
            isRunning: false 
        });
    };

    window.deleteTimer = (key) => {
        if(confirm("Hapus timer ini?")) {
            remove(ref(db, `multiTimers/${key}`));
        }
    };

    // Stopwatch Actions
    window.toggleStopwatch = (status) => update(stopwatchRef, { isRunning: status });
    window.resetStopwatch = () => {
        if(confirm("Reset Stopwatch dan Uang ke 0?")) {
            update(stopwatchRef, { seconds: 0, money: 0, isRunning: false });
        }
    };

    // Global Actions
    window.deleteAll = async () => {
        if (!isAdmin) return alert("Akses Ditolak!");
        if (confirm("‚ö†Ô∏è BAHAYA: Hapus SEMUA timer dan reset stopwatch?")) {
            await set(timersRef, null);
            await set(stopwatchRef, { seconds: 0, money: 0, isRunning: false });
        }
    };

</script>
</body>
</html>
