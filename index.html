<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Billing Timer (Viewer & Admin)</title>
<style>
    :root {
        --bg: #121212;
        --card: #1e1e1e;
        --text: #ffffff;
        --timer-color: #3498db;
        --stopwatch-color: #9b59b6;
        --danger: #e74c3c;
        --success: #2ecc71;
        --warning: #f1c40f;
    }

    body {
        font-family: 'Segoe UI', Roboto, sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
    }

    /* Buttons */
    button {
        padding: 10px 15px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        color: white;
        transition: 0.2s;
    }
    button:active { transform: scale(0.95); }
    .btn-timer { background: var(--timer-color); }
    .btn-sw { background: var(--stopwatch-color); }
    .btn-danger { background: var(--danger); }
    .btn-success { background: var(--success); }
    .btn-control { width: 40px; height: 40px; font-size: 1.2rem; padding: 0; margin: 0 5px; }

    /* Main Menu (Hidden by default, shown for Admin) */
    #main-menu { display: none; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }

    /* Input Panels */
    .control-panel {
        display: none;
        background: #252525;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #444;
        gap: 15px;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
        width: 100%;
        max-width: 400px;
    }
    
    .input-group { display: flex; gap: 10px; width: 100%; justify-content: center; }
    input { padding: 10px; background: #333; border: 1px solid #555; color: white; border-radius: 5px; text-align: center; }
    .input-name { width: 100%; text-align: left; }
    .input-time { width: 60px; }
    .input-money { width: 100%; color: var(--warning); font-weight: bold; }

    /* Radio Mode Switcher */
    .mode-switch {
        display: flex;
        gap: 15px;
        margin-bottom: 5px;
        background: #333;
        padding: 5px;
        border-radius: 5px;
    }
    .mode-switch label { cursor: pointer; padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; }
    .mode-switch input[type="radio"] { display: none; }
    .mode-switch input[type="radio"]:checked + span { color: var(--timer-color); font-weight: bold; text-decoration: underline; }

    /* Container */
    #container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        width: 100%;
        max-width: 1200px;
    }

    /* Cards */
    .card {
        background: var(--card);
        border: 1px solid #333;
        border-radius: 15px;
        padding: 20px;
        width: 280px;
        text-align: center;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center; /* Center content vertically */
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        min-height: 150px;
    }
    .card.timer-mode { border-top: 4px solid var(--timer-color); }
    .card.sw-mode { border-top: 4px solid var(--stopwatch-color); }
    
    .card-title { color: #aaa; font-size: 0.9rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
    .time-display { font-size: 3.5rem; font-weight: 700; font-variant-numeric: tabular-nums; margin: 10px 0; line-height: 1; }
    .money-display { color: var(--warning); font-weight: bold; font-size: 1.2rem; margin-bottom: 5px; }
    
    .badge {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 0.7rem;
        padding: 3px 6px;
        border-radius: 4px;
        background: #333;
    }
    .running .badge { background: var(--success); color: #000; }
    
    /* Card Controls (Hanya muncul untuk Admin) */
    .card-controls {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #333;
        display: flex;
        justify-content: center;
        gap: 5px;
    }
    
    #role-indicator { margin-top: auto; padding: 30px; color: #555; font-size: 0.8rem; }
    
    .hidden { display: none !important; }
    .helper-text { font-size: 0.8rem; color: #888; margin-top: -10px; }
</style>
</head>
<body>

    <h1 style="color:#888;">BILLING MONITOR</h1>

    <div id="main-menu">
        <button class="btn-timer" onclick="togglePanel('timer')">+ Timer Baru</button>
        <button class="btn-sw" onclick="togglePanel('stopwatch')">+ Stopwatch Baru</button>
        <button class="btn-danger" onclick="deleteAll()">Reset Sistem</button>
    </div>

    <div id="panel-timer" class="control-panel">
        <input id="timerName" class="input-name" placeholder="Nama / No. Meja">
        <div class="mode-switch">
            <label>
                <input type="radio" name="inputMode" value="time" checked onchange="switchInputMode('time')">
                <span>Input Waktu</span>
            </label>
            <label>
                <input type="radio" name="inputMode" value="money" onchange="switchInputMode('money')">
                <span>Input Rupiah</span>
            </label>
        </div>
        <div id="input-time-wrapper" class="input-group">
            <input id="timerHours" class="input-time" type="number" min="0" placeholder="Jam">
            <span style="align-self:center; font-weight:bold;">:</span>
            <input id="timerMinutes" class="input-time" type="number" min="0" placeholder="Mnt">
        </div>
        <div id="input-money-wrapper" class="input-group hidden" style="flex-direction:column; align-items:center;">
            <input id="timerMoney" class="input-money" type="number" min="0" placeholder="Rp Nominal" step="1000">
            <span class="helper-text">Rp 1.000 = 12 Menit</span>
        </div>
        <button class="btn-success" style="width:100%" onclick="addTimer()">TAMBAH</button>
    </div>

    <div id="panel-stopwatch" class="control-panel">
        <input id="swName" class="input-name" placeholder="Nama Stopwatch">
        <button class="btn-success" style="width:100%" onclick="addStopwatch()">TAMBAH</button>
    </div>

    <div id="container">
        <h3 style="color:#444; margin-top:50px;">Memuat Data...</h3>
    </div>

    <div id="role-indicator">MODE: VIEWER (READ ONLY)</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, remove, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCb9y-NzS2coR8UFlWE6Nb3r27baCS1mz4",
        authDomain: "timer-89517.firebaseapp.com",
        databaseURL: "https://timer-89517-default-rtdb.firebaseio.com",
        projectId: "timer-89517"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    const timersRef = ref(db, "v3/timers");
    const stopwatchRef = ref(db, "v3/stopwatches");

    let timersData = {};
    let stopwatchData = {};
    let isAdmin = false;

    // --- AUTH CHECK ---
    const urlParams = new URLSearchParams(location.search);
    if (urlParams.get("role") === "admin") {
        const pwd = prompt("MASUKKAN PASSWORD ADMIN:");
        if (pwd === "redmimahal") {
            isAdmin = true;
            document.getElementById("role-indicator").innerText = "MODE: ADMIN (MASTER)";
            document.getElementById("role-indicator").style.color = "#e74c3c";
            document.getElementById("main-menu").style.display = "flex"; // Tampilkan menu tambah
        } else {
            alert("Password Salah! Anda masuk sebagai Viewer.");
        }
    }

    // --- DATABASE LISTENER ---
    onValue(timersRef, (snap) => { timersData = snap.val() || {}; });
    onValue(stopwatchRef, (snap) => { stopwatchData = snap.val() || {}; });

    // --- RENDER LOOP (Setiap 0.2 detik) ---
    setInterval(() => {
        const container = document.getElementById("container");
        let htmlContent = "";
        const now = Date.now();

        // 1. RENDER TIMER
        Object.keys(timersData).forEach(key => {
            const t = timersData[key];
            let remainingMS = 0;

            if (t.isRunning) {
                remainingMS = t.endTime - now;
                if (remainingMS < 0) remainingMS = 0;
            } else {
                remainingMS = t.pausedLeft;
            }

            const totalSeconds = Math.ceil(remainingMS / 1000);
            const h = String(Math.floor(totalSeconds / 3600)).padStart(2,"0");
            const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2,"0");
            const s = String(totalSeconds % 60).padStart(2,"0");

            // LOGIKA KONTROL: Hanya buat HTML tombol jika ADMIN
            const controlsHTML = isAdmin ? `
                <div class="card-controls">
                    <button class="btn-control ${t.isRunning?'btn-danger':'btn-success'}" 
                        onclick="window.toggleTimer('${key}', ${!t.isRunning})">
                        ${t.isRunning ? '⏸' : '▶'}
                    </button>
                    <button class="btn-control btn-timer" onclick="window.resetTimer('${key}')">↺</button>
                    <button class="btn-control btn-danger" onclick="window.deleteItem('timers', '${key}')">✖</button>
                </div>
            ` : ''; // Jika Viewer, kosongkan string ini

            htmlContent += `
                <div class="card timer-mode ${t.isRunning && remainingMS > 0 ?'running':''}">
                    <div class="badge">${t.isRunning && remainingMS > 0 ?'JALAN':'PAUSE'}</div>
                    <div class="card-title">${t.name}</div>
                    <div class="time-display">${h}:${m}:${s}</div>
                    ${controlsHTML} 
                </div>
            `;
        });

        // 2. RENDER STOPWATCH
        Object.keys(stopwatchData).forEach(key => {
            const sw = stopwatchData[key];
            let elapsedMS = 0;

            if (sw.isRunning) {
                elapsedMS = (now - sw.startTime) + (sw.accumulated || 0);
            } else {
                elapsedMS = sw.accumulated || 0;
            }

            const totalSeconds = Math.floor(elapsedMS / 1000);
            const h = String(Math.floor(totalSeconds / 3600)).padStart(2,"0");
            const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2,"0");
            const s = String(totalSeconds % 60).padStart(2,"0");
            
            // Rate sama: 1000 Rupiah = 12 Menit
            // Rumus: (Total Menit / 12) * 1000
            const totalMinutes = totalSeconds / 60;
            const money = Math.floor((totalMinutes / 12) * 1000); 

            // LOGIKA KONTROL: Hanya buat HTML tombol jika ADMIN
            const controlsHTML = isAdmin ? `
                <div class="card-controls">
                    <button class="btn-control ${sw.isRunning?'btn-danger':'btn-success'}" 
                        onclick="window.toggleStopwatch('${key}', ${!sw.isRunning})">
                        ${sw.isRunning ? '⏸' : '▶'}
                    </button>
                    <button class="btn-control btn-danger" onclick="window.resetStopwatch('${key}')">↺</button>
                    <button class="btn-control btn-danger" onclick="window.deleteItem('stopwatches', '${key}')">✖</button>
                </div>
            ` : '';

            htmlContent += `
                <div class="card sw-mode ${sw.isRunning?'running':''}">
                    <div class="badge">${sw.isRunning?'JALAN':'PAUSE'}</div>
                    <div class="card-title">${sw.name}</div>
                    <div class="time-display">${h}:${m}:${s}</div>
                    <div class="money-display">Rp ${money.toLocaleString('id-ID')}</div>
                    ${controlsHTML}
                </div>
            `;
        });

        if (htmlContent === "") {
            container.innerHTML = `<h3 style="color:#666">Belum ada Timer aktif.</h3>`;
        } else {
            container.innerHTML = htmlContent;
        }

    }, 200);

    // --- FUNGSI UI & LOGIC (SAMA SEPERTI SEBELUMNYA) ---
    window.togglePanel = (type) => {
        document.querySelectorAll('.control-panel').forEach(el => el.style.display = 'none');
        document.getElementById(`panel-${type}`).style.display = 'flex';
    };

    window.switchInputMode = (mode) => {
        if(mode === 'time') {
            document.getElementById('input-time-wrapper').classList.remove('hidden');
            document.getElementById('input-money-wrapper').classList.add('hidden');
        } else {
            document.getElementById('input-time-wrapper').classList.add('hidden');
            document.getElementById('input-money-wrapper').classList.remove('hidden');
        }
    };

    window.addTimer = () => {
        if(!isAdmin) return;
        const name = document.getElementById("timerName").value || "Pelanggan";
        const inputMode = document.querySelector('input[name="inputMode"]:checked').value;
        let durationMS = 0;

        if (inputMode === 'time') {
            const h = parseInt(document.getElementById("timerHours").value) || 0;
            const m = parseInt(document.getElementById("timerMinutes").value) || 0;
            durationMS = ((h * 3600) + (m * 60)) * 1000;
        } else {
            const money = parseInt(document.getElementById("timerMoney").value) || 0;
            if (money <= 0) return alert("Masukkan nominal uang!");
            // Rate: Rp 1000 = 12 Menit
            const totalMinutes = (money / 1000) * 12;
            durationMS = totalMinutes * 60 * 1000;
        }

        if (durationMS <= 0) return alert("Waktu minimal!");
        push(timersRef, { name, originalDuration: durationMS, pausedLeft: durationMS, endTime: 0, isRunning: false });
        
        document.getElementById("timerName").value = "";
        document.getElementById("timerMoney").value = "";
        document.getElementById("timerHours").value = "";
        document.getElementById("timerMinutes").value = "";
    };

    window.addStopwatch = () => {
        if(!isAdmin) return;
        const name = document.getElementById("swName").value || "Stopwatch";
        push(stopwatchRef, { name, startTime: 0, accumulated: 0, isRunning: false });
        document.getElementById("swName").value = "";
    };

    window.toggleTimer = (key, wantStart) => {
        if(!isAdmin) return;
        const t = timersData[key];
        const now = Date.now();
        if (wantStart) {
            update(ref(db, `v3/timers/${key}`), { isRunning: true, endTime: now + t.pausedLeft });
        } else {
            const currentRemaining = t.endTime - now;
            update(ref(db, `v3/timers/${key}`), { isRunning: false, pausedLeft: currentRemaining > 0 ? currentRemaining : 0 });
        }
    };

    window.resetTimer = (key) => {
        if(!isAdmin) return;
        const t = timersData[key];
        update(ref(db, `v3/timers/${key}`), { isRunning: false, pausedLeft: t.originalDuration, endTime: 0 });
    };

    window.toggleStopwatch = (key, wantStart) => {
        if(!isAdmin) return;
        const sw = stopwatchData[key];
        const now = Date.now();
        if (wantStart) {
            update(ref(db, `v3/stopwatches/${key}`), { isRunning: true, startTime: now });
        } else {
            const sessionDuration = now - sw.startTime;
            update(ref(db, `v3/stopwatches/${key}`), { isRunning: false, accumulated: (sw.accumulated || 0) + sessionDuration });
        }
    };

    window.resetStopwatch = (key) => {
        if(!isAdmin) return;
        update(ref(db, `v3/stopwatches/${key}`), { isRunning: false, accumulated: 0, startTime: 0 });
    };

    window.deleteItem = (type, key) => {
        if(!isAdmin) return;
        if(confirm("Hapus item ini?")) remove(ref(db, `v3/${type}/${key}`));
    };

    window.deleteAll = async () => {
        if(!isAdmin) return;
        if(confirm("RESET SEMUA KE NOL?")) await set(ref(db, 'v3'), null);
    };

</script>
</body>
</html>
